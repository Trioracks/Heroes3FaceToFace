<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Лицом к лицу 1.07 База данных героев</title>
  
  <!-- Google Fonts: Герои 3 стиль -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Press Start 2P', cursive;
      color: #e0d0a0;
      text-shadow: 1px 1px 2px #000;
      letter-spacing: 1px;
      background-color: transparent;
      font-size: 0.75rem;
    }

    body {
      background: url('https://i.postimg.cc/qv2pzHrV/image.gif') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      padding: 15px;
      background-color: #0a0a1a;
    }

    .container {
      background-color: rgba(0, 15, 50, 0.1);
      border: 3px solid #6e4f1a;
      border-radius: 8px;
      box-shadow: 
        inset 0 0 20px rgba(0, 0, 0, 0.7),
        0 0 15px rgba(200, 150, 50, 0.4);
      padding: 20px;
      margin-top: 20px;
      max-width: 1500px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }

    h1 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.1rem;
      color: #f0d070;
      text-shadow: 0 2px 4px #000, 0 0 10px rgba(255, 220, 100, 0.5);
      letter-spacing: 1px;
      text-transform: uppercase;
      background: linear-gradient(to right, #e0b050, #f0d070);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: normal;
      padding: 5px 0;
      border-bottom: 2px solid #b08030;
    }

    .filter-row {
      background: rgba(0, 15, 50, 0.7);
      border: 2px solid #6e4f1a;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 5px;
    }

    .filter-input {
      background: rgba(0, 30, 80, 0.8);
      color: #e0d0a0;
      border: 1px solid #a07030;
      border-radius: 2px;
      font-size: 0.7rem;
      padding: 4px;
      text-shadow: 0 1px 2px #000;
    }

    .filter-input::placeholder {
      color: #a08050;
    }

    .table-container {
      position: relative;
      border: 3px solid #6e4f1a;
      border-radius: 4px;
      overflow: hidden;
      background: rgba(0, 15, 50, 0.7);
      margin-top: 10px;
    }

    .table-responsive {
      overflow-x: auto;
      border: 1px solid #3498db;
      border-radius: 4px;
    }

    .table {
      background: rgba(0, 25, 70, 0.85);
      border: 1px solid #004488;
      color: #e0e0e0;
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      font-size: 0.7rem;
    }

    .table th {
      background: rgba(0, 40, 120, 0.9);
      color: #f0d070;
      border-bottom: 2px solid #b08030;
      font-weight: normal;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 5px;
      border-right: 1px solid #805020;
      white-space: nowrap;
    }

    .table td {
      border-top: 1px solid #004488;
      vertical-align: middle !important;
      padding: 4px;
      border-right: 1px solid #805020;
      background: rgba(0, 20, 60, 0.6);
      word-wrap: break-word;
    }

    /* Ширина столбцов */
    .table th:nth-child(1), 
    .table td:nth-child(1) { width: 60px; }
    .table th:nth-child(2), 
    .table td:nth-child(2) { width: 120px; }
    .table th:nth-child(3), 
    .table td:nth-child(3) { width: 100px; }
    .table th:nth-child(4), 
    .table td:nth-child(4) { width: 120px; }
    .table th:nth-child(5), 
    .table td:nth-child(5) { width: 150px; }
    .table th:nth-child(6), 
    .table td:nth-child(6) { width: 100px; }
    .table th:nth-child(7), 
    .table td:nth-child(7) { width: 250px; }

    .castle-icon {
      width: 40px;
      height: 40px;
      display: block;
      margin: 0 auto;
      border: 1px solid #a07030;
      border-radius: 2px;
      background: #0a0a1a;
      box-shadow: 0 0 5px rgba(200, 150, 50, 0.3);
    }

    .hero-name {
      color: #f0d070;
      font-weight: bold;
    }

    .special-skill {
      color: #a0c0f0;
      font-style: italic;
    }

    .spell {
      color: #c0a0f0;
    }

    .no-data {
      background: rgba(0, 20, 60, 0.8);
      border: 1px solid #6e4f1a;
      border-radius: 4px;
      padding: 15px;
      text-align: center;
      font-size: 0.9rem;
      color: #f0d070;
      margin-top: 10px;
    }

    /* Лоадер в стиле Heroes 3 */
    .loader-container {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10;
      justify-content: center;
      align-items: center;
    }

    .loader-box {
      background: rgba(0, 20, 60, 0.8);
      border: 3px solid #6e4f1a;
      border-radius: 8px;
      padding: 15px;
      width: 80%;
      max-width: 600px;
      text-align: center;
      box-shadow: 0 0 20px rgba(255, 220, 100, 0.4);
    }

    .loader-header {
      color: #f0d070;
      font-size: 0.9rem;
      margin-bottom: 12px;
      text-shadow: 0 2px 4px #000;
    }

    .loader-bar {
      height: 20px;
      background: #1a1a2a;
      border: 1px solid #6e4f1a;
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }

    .loader-fill {
      height: 100%;
      background: linear-gradient(to right, #e0b050, #f0d070);
      width: 0%;
      transition: width 0.3s ease;
    }

    .loader-text {
      color: #f0d070;
      font-size: 0.8rem;
      text-shadow: 0 1px 2px #000;
    }

    /* Убираем ненужные элементы DataTables */
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_paginate,
    .dataTables_info {
      display: none !important;
    }

    /* Стиль для заголовка */
    h1 span {
      color: #f0d070;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7), 0 0 10px rgba(255, 204, 0, 0.5);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>База данных героев. Лицом к лицу 1.07</h1>
    
    <div class="filter-row">
      <input type="text" class="filter-input" placeholder="Фильтр по замку" id="filter-castle">
      <input type="text" class="filter-input" placeholder="Фильтр по имени" id="filter-name">
      <input type="text" class="filter-input" placeholder="Фильтр по спец-я" id="filter-special">
      <input type="text" class="filter-input" placeholder="Фильтр по закл-е" id="filter-spell">
    </div>
    
    <div class="table-container">
      <div class="loader-container" id="loader">
        <div class="loader-box">
          <div class="loader-header">Загрузка данных</div>
          <div class="loader-bar">
            <div class="loader-fill" id="loader-fill"></div>
          </div>
          <div class="loader-text" id="loader-text">0%</div>
        </div>
      </div>
      
      <div class="table-responsive">
        <table id="heroes-table" class="table">
          <thead>
            <tr>
              <th>Замок</th>
              <th>Герой</th>
              <th>Спец-я</th>
              <th>Закл-е</th>
              <th>Навыки</th>
              <th>Арт</th>
              <th>Параметры</th>
            </tr>
          </thead>
          <tbody>
            <!-- Данные загрузятся здесь -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // Объект с иконками замков (без пробелов)
    const castleIcons = {
      "Оплот": "https://i.postimg.cc/g0GN88fS/image.png",
      "Башня": "https://i.postimg.cc/CxGcRm6Q/image.png",
      "Сопряжение": "https://i.postimg.cc/Sx6gnDtT/image.png",
      "Инферно": "https://i.postimg.cc/dV25h4SS/image.png",
      "Причал": "https://i.postimg.cc/0yYVzcHT/image.png",
      "Цитадель": "https://i.postimg.cc/CKwmkkWX/image.png",
      "Крепость": "https://i.postimg.cc/bvq3kkKF/image.png",
      "Фабрика": "https://i.postimg.cc/W1G5dXf7/image.png",
      "Темница": "https://i.postimg.cc/XvnQddTh/image.png",
      "Замок": "https://i.postimg.cc/yN7vccwf/image.png",
      "Некрополис": "https://i.postimg.cc/x1v6XtFp/image.png"
    };

    // API URL (без пробелов)
    const API_URL = "https://script.google.com/macros/s/AKfycbxuqXY9GOsSwrL7qBkpUmhctyr4QNQzeKuz3XI9XZDsmePLCTJtWgH9XgrMOrtpXCxOKQ/exec";

    // Элементы лоадера
    const loader = document.getElementById('loader');
    const loaderFill = document.getElementById('loader-fill');
    const loaderText = document.getElementById('loader-text');

    async function loadHeroesData() {
      try {
        // Показываем лоадер
        loader.style.display = 'flex';
        loaderFill.style.width = '0%';
        loaderText.textContent = '0%';

        // Имитируем прогресс загрузки
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 10;
          if (progress > 95) progress = 95;
          loaderFill.style.width = `${progress}%`;
          loaderText.textContent = `${Math.floor(progress)}%`;
        }, 200);

        const response = await fetch(API_URL);
        const data = await response.json();
        
        // Логируем полученные данные
        console.log("Полученные данные из API:", data);
        
        const tbody = document.querySelector("#heroes-table tbody");
        tbody.innerHTML = ""; // Очищаем таблицу

        if (data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center">
                <div class="no-data">Данные не найдены</div>
              </td>
            </tr>
          `;
          clearInterval(progressInterval);
          loaderFill.style.width = '100%';
          loaderText.textContent = '100%';
          setTimeout(() => {
            loader.style.display = 'none';
          }, 500);
          return;
        }

        // Показываем прогресс загрузки данных
        const total = data.length;
        let loaded = 0;
        
        data.forEach(hero => {
          // Логируем каждую строку
          console.log("Обработка героя:", hero);
          
          // Формируем строку таблицы
          const row = document.createElement("tr");
          
          // Родной замок (с иконкой и подсказкой)
          const castleName = hero["Родной замок"] || "";
          const castleIcon = castleIcons[castleName] || "";
          const castleHtml = castleIcon ? 
            `<div style="text-align:center;"><img src="${castleIcon}" class="castle-icon" title="${castleName}"></div>` : 
            `<div style="text-align:center; color:#a08050">${castleName}</div>`;
          row.innerHTML += `<td>${castleHtml}</td>`;
          
          // Остальные поля
          row.innerHTML += `
            <td><span class="hero-name">${hero["Название героя"] || "—"}</span></td>
            <td class="special-skill">${hero["Специализация"] || "—"}</td>
            <td class="spell">${hero["Заклинание"] || "—"}</td>
            <td>${hero["Вторичные навыки"] || "—"}</td>
            <td>${hero["Артефакт"] || "—"}</td>
            <td>${hero["Первичные навыки"] || "—"}</td>
          `;
          
          tbody.appendChild(row);
          
          // Обновляем прогресс
          loaded++;
          const currentProgress = 95 + Math.floor((loaded / total) * 5);
          loaderFill.style.width = `${currentProgress}%`;
          loaderText.textContent = `${Math.floor(currentProgress)}%`;
        });

        // Инициализируем DataTables
        const table = new DataTable('#heroes-table', {
          "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/ru.json"
          },
          "pageLength": -1,
          "lengthChange": false,
          "order": [[1, "asc"]],
          "initComplete": function() {
            // Добавляем фильтры по столбцам
            this.api().columns().every(function() {
              const column = this;
              const header = $(column.header());
              
              // Убираем фильтры для столбцов "Замок" и "Герой"
              if (header.index() === 0 || header.index() === 1) return;
              
              const input = document.createElement('input');
              input.placeholder = 'Фильтр...';
              input.className = 'filter-input';
              
              $(input).appendTo($(column.header()))
                .on('keyup change', function() {
                  if (column.search() !== this.value) {
                    column
                      .search(this.value)
                      .draw();
                  }
                });
            });
            
            // Добавляем обработку фильтров вручную
            $('#filter-castle').on('keyup', function() {
              table.column(0).search(this.value).draw();
            });
            $('#filter-name').on('keyup', function() {
              table.column(1).search(this.value).draw();
            });
            $('#filter-special').on('keyup', function() {
              table.column(2).search(this.value).draw();
            });
            $('#filter-spell').on('keyup', function() {
              table.column(3).search(this.value).draw();
            });
            
            // Скрываем лоадер
            clearInterval(progressInterval);
            loaderFill.style.width = '100%';
            loaderText.textContent = '100%';
            setTimeout(() => {
              loader.style.display = 'none';
            }, 500);
          }
        });

      } catch (error) {
        console.error("Ошибка загрузки данных:", error);
        document.querySelector("#heroes-table tbody").innerHTML = `
          <tr>
            <td colspan="7" class="text-center">
              <div class="no-data">Ошибка загрузки данных</div>
            </td>
          </tr>
        `;
        
        // Скрываем лоадер при ошибке
        clearInterval(progressInterval);
        loaderFill.style.width = '0%';
        loaderText.textContent = '0%';
        setTimeout(() => {
          loader.style.display = 'none';
        }, 500);
      }
    }

    // Загружаем данные при загрузке страницы
    document.addEventListener("DOMContentLoaded", loadHeroesData);
  </script>
</body>
</html>